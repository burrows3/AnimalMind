#!/usr/bin/env node
/**
 * Agent: Synthesizer. Runs after surveillance and literature reviewers.
 * Reads their outputs + autonomous-insights, writes "opportunities to improve
 * the field" so agents (and humans) can act. Cost: $0 by default; optional NVIDIA
 * LLM synthesis when NVIDIA_API_KEY is set.
 */

require('../lib/env');
const fs = require('fs');
const path = require('path');
const { chat: nvidiaChat, isEnabled: isNvidiaEnabled } = require('../lib/nvidiaNim');

const MEMORY_DIR = path.join(__dirname, '..', 'memory');
const AGENT_OUTPUTS = path.join(MEMORY_DIR, 'agent-outputs');
const OUT_PATH = path.join(MEMORY_DIR, 'opportunities.md');

const FILES = {
  surveillance: path.join(AGENT_OUTPUTS, 'surveillance-review.md'),
  literature: path.join(AGENT_OUTPUTS, 'literature-review.md'),
  insights: path.join(MEMORY_DIR, 'autonomous-insights.md'),
};

function readSafe(p) {
  try {
    return fs.existsSync(p) ? fs.readFileSync(p, 'utf8') : '';
  } catch {
    return '';
  }
}

function truncate(text, maxChars) {
  if (!text) return '';
  return text.length > maxChars ? `${text.slice(0, maxChars)}…` : text;
}

async function buildLlmSynthesis({ surveillanceText, literatureText, insightsText }) {
  if (!isNvidiaEnabled()) return null;
  const user = [
    'Synthesize the most actionable opportunities for animal health.',
    'Use the inputs below (truncated).',
    '',
    'Surveillance reviewer:',
    truncate(surveillanceText, 2000) || '(empty)',
    '',
    'Literature reviewer:',
    truncate(literatureText, 2500) || '(empty)',
    '',
    'Autonomous insights:',
    truncate(insightsText, 1500) || '(empty)',
    '',
    'Return 5-8 opportunities as bullet points. Each bullet should include:',
    '- the opportunity',
    '- who should act (e.g., clinics, researchers, public health)',
    '- a short next step',
    'No extra preamble.',
  ].join('\n');
  try {
    return await nvidiaChat({
      system: 'You are an autonomous synthesizer for veterinary and one-health opportunities.',
      user,
      maxTokens: 520,
      temperature: 0.2,
    });
  } catch (e) {
    console.warn('agent-synthesize-opportunities: LLM unavailable:', e.message);
    return null;
  }
}

async function main() {
  const surveillanceText = readSafe(FILES.surveillance);
  const literatureText = readSafe(FILES.literature);
  const insightsText = readSafe(FILES.insights);

  const lines = [
    '# Opportunities to improve the field',
    '',
    '**Generated by:** Synthesizer agent (reads Surveillance reviewer + Literature reviewer + autonomous insights)',
    '**Last run:** ' + new Date().toISOString(),
    '',
    '---',
    '',
    '## How this was built',
    '',
    'Multiple agents run autonomously after each ingest:',
    '1. **Surveillance reviewer** — reviews CDC/surveillance data.',
    '2. **Literature reviewer** — reviews literature, cancer, case data.',
    '3. **Synthesizer** (this agent) — reads their outputs and writes opportunities below.',
    '',
    '---',
    '',
    '## Opportunities (from agent thinking)',
    '',
  ];

  const llmSynthesis = await buildLlmSynthesis({ surveillanceText, literatureText, insightsText });
  if (llmSynthesis) {
    lines.push('### LLM synthesis (NVIDIA)', '');
    lines.push(llmSynthesis, '');
  }

  const hasSurveillance = surveillanceText.length > 0 && surveillanceText.includes('## What I see');
  const hasLiterature = literatureText.length > 0 && literatureText.includes('## Themes');
  const hasInsights = insightsText.length > 0 && insightsText.includes('## Consider');

  if (!hasSurveillance && !hasLiterature && !hasInsights) {
    lines.push('*No agent outputs yet. Run ingest, then the agent chain (surveillance → literature → synthesizer).*', '');
  } else {
    lines.push('### From surveillance', '');
    if (hasSurveillance) {
      const condMatch = surveillanceText.match(/- \*\*([^*]+)\*\*/g);
      const conditions = condMatch ? condMatch.slice(0, 10).map((s) => s.replace(/^- \*\*|\*\*$/g, '')) : [];
      if (conditions.length) {
        lines.push('**Conditions to watch (travel / zoonotic):**');
        conditions.forEach((c) => lines.push(`- ${c} — consider travel alerts or client advice.`));
        lines.push('');
        lines.push('**Opportunity:** Review new CDC notices and surface alerts for vets and one-health partners.');
      } else {
        lines.push('- Use surveillance reviewer output for travel and zoonotic alerts.');
      }
    } else {
      lines.push('- Run surveillance reviewer first.');
    }
    lines.push('');

    lines.push('### From literature', '');
    if (hasLiterature) {
      lines.push('- **Partnerships:** New one-health and cancer papers suggest collaboration and comparative oncology opportunities.');
      lines.push('- **Research gaps:** Case reports and literature themes point to teaching material and emerging patterns.');
      lines.push('- **Opportunity:** Summarize "new this period" for researchers and clinics.');
    } else {
      lines.push('- Run literature reviewer first.');
    }
    lines.push('');

    lines.push('### Reasoning by autonomous-agent topic', '');
    const reasoningMatch = literatureText.match(/## Reasoning by autonomous-agent topic[\s\S]*?(?=\n## |$)/);
    if (reasoningMatch && reasoningMatch[0].trim().length > 80) {
      const reasoningBlock = reasoningMatch[0].replace(/^## Reasoning by autonomous-agent topic\n\n?/, '').trim();
      lines.push('The literature reviewer reasons over ingested data for each autonomous-agent topic (Clinical-Adjacent and Research & Discovery). Inferred opportunities:', '');
      lines.push(reasoningBlock.split('\n').filter(Boolean).map((l) => l.trim()).join('\n'), '');
    } else {
      lines.push('- Topic-wise reasoning appears after the literature reviewer runs with topic-ingested data.', '');
    }
    lines.push('');

    lines.push('### From system insights', '');
    if (hasInsights) {
      lines.push('- Surveillance: review new CDC travel notices for alerts.');
      lines.push('- Literature: review new papers for partnerships and gaps.');
      lines.push('- Cancer / case data / imaging: use for teaching, collaboration, or model development.');
    } else {
      lines.push('- Run ingest and think-autonomous first.');
    }
    lines.push('');

    lines.push('### For veterinary medicine (clinic use)', '');
    lines.push('- **In the clinic:** Use surveillance for travel/zoonotic client advice; clinical + case_data for differentials, protocols, and CE; vet_practice (AAHA, AVMA, VIN, Merck) for guidelines and client handouts.');
    lines.push('- **Opportunities:** New clinical/small animal/equine papers → protocols or rounds; new case reports → teaching or client materials; vet_practice links → client resources.');
    lines.push('');
  }

  lines.push('---', '');
  lines.push('*Agents run on the same machine (or VM) after each ingest. Add more reviewers by adding scripts and having the synthesizer read them.*');
  lines.push('');

  if (!fs.existsSync(MEMORY_DIR)) fs.mkdirSync(MEMORY_DIR, { recursive: true });
  fs.writeFileSync(OUT_PATH, lines.join('\n'), 'utf8');
  console.log('agent-synthesize-opportunities: wrote', OUT_PATH);
}

main().catch((err) => {
  console.error('agent-synthesize-opportunities: failed', err.message);
  process.exit(1);
});
